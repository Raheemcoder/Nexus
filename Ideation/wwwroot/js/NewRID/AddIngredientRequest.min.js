function convertDateToString(n){if(n===""||n===null)return"";const t=new Date(n),i=t.getFullYear(),r=("0"+(t.getMonth()+1)).slice(-2),u=("0"+t.getDate()).slice(-2);return`${i}-${r}-${u}`}function validateSave(){var n=!1,t=$("#IngredientName").val().toLowerCase().trim(),i=$("#Synonyms").val().toLowerCase().trim(),r=$("#CASNumber").val().toLowerCase().trim(),u=$("#FunctionId_arr").val().join(",").toString();return(oldingredientname!=t||oldsynonyms!=i||oldcasnumber!=r||oldfunctionid!=u)&&(n=!0),$.each(gridData,function(t){var i=convertDateToString(old_gridData[t].ImpactDates),r=convertDateToString(gridData[t].ImpactDates);(parseInt(old_gridData[t].RegionId)!=parseInt(gridData[t].RegionId)||parseInt(old_gridData[t].CategoryId)!=parseInt(gridData[t].CategoryId)||parseInt(old_gridData[t].RegulatoryStatus)!=parseInt(gridData[t].RegulatoryStatus)||old_gridData[t].CRemarks.toLowerCase().trim()!=gridData[t].CRemarks.toLowerCase().trim()||i!=r||old_gridData[t].References.toLowerCase().trim()!=gridData[t].References.toLowerCase().trim())&&(n=!0)}),documentData.length>0&&(n=!0),n}function SaveUploadedFiles(n,t){var n=parseInt(n),i=new FormData;i.append("IngredientId",n);i.append("JsonFileNames",JSON.stringify(fileName));i.append("Division_Id",$("#Division_Id").val());t!="Save"?i.append("Source",$("#Source").val()):"";i.append("DocumentData",JSON.stringify(documentData));const r=gridData.map(n=>n.RegionId),u=[...new Set(r)];$.each(u,function(n,t){for(var o,s,r,f,e=0,u=1;u<=gridData.length;u++)if(o=$("#RefDoc_"+u).get(0),s=gridData[u-1].RegionId,parseInt(t)===parseInt(s)&&(r=o.files,r.length!="0"||r.length!=0))for(e++,f=0;f<r.length;f++)i.append("PostedFile",r[f]);e>0&&$.ajax({url:ROOT+"NewRID/UploadFile",dataType:"JSON",type:"POST","async":!1,data:i,contentType:!1,processData:!1,success:function(){},error:function(){alert(" An Error occured!!")}})})}function bindregulatorystatusDropDown(){$.ajax({url:ROOT+"NewRID/GetRegulatoryStatus",dataType:"JSON","async":!1,type:"GET",success:function(n){$.each(n,function(n,t){$(".regulatorystatus_c").append("<option value="+t.Value+">"+t.Text+"<\/option>")})}});$(".regulatorystatus_c").select2()}function convertToDate(n){const[t,i,r]=n.split("/");return new Date(`${r}-${i}-${t}`)}var gridData=[],fileName=[],documentData=[],login_region=[],ingredientNames=[],ingredientId=parseInt($("#IngredientId").val()),oldingredientname="",oldsynonyms="",oldcasnumber="",oldfunctionid="",old_gridData=[];$(document).ready(function(){var n,t,i;oldingredientname=$("#IngredientName").val().toLowerCase().trim();oldsynonyms=$("#Synonyms").val().toLowerCase().trim();oldcasnumber=$("#CASNumber").val().toLowerCase().trim();oldfunctionid=$("#FunctionId_arr").val().join(",").toString();$("body").on("change",".textvalid",function(){var n=$(this)[0].id,t=this.value.trim();t===""?$("#"+n+"_valid").removeClass("_hide"):$("#"+n+"_valid").addClass("_hide")});$("body").on("keyup",".textvalid",function(){var n=$(this)[0].id,t=this.value.trim();t===""?($("#"+n+"_valid").removeClass("_hide"),$("#IngredientName_exists").addClass("_hide")):$("#"+n+"_valid").addClass("_hide")});n=JSON.parse($("#DivisionBasedIngredientListJson").val());gridData=n;ingredientNames=JSON.parse($("#IngredientNameList").val());old_gridData=JSON.parse($("#DivisionBasedIngredientListJson").val());arrtSetting=function(n,i){var r;return r=(t=undefined||t!=i)?' rowspan="4"':' style="display:none"',t=i,r};$("#list").jqGrid({datatype:"local",data:n,colNames:["RowNo","Region","Category","Regulatory Status","Compliance Remarks","Impact Date","References","Ref Documents"],colModel:[{name:"RowNo",align:"center",hidden:!0},{name:"Region",width:50,align:"center",classes:"trs",cellattr:arrtSetting,formatter:function(n,t,i){if(i.IsEditable==!0){var r=login_region.findIndex(function(t){return t===n});r==-1?login_region.push(n):""}return n}},{name:"Category",classes:"trs1",width:60,formatter:function(n){return n}},{name:"RegulatoryStatus",search:!1,width:80,formatter:function(n,t,i){var r;return i.IsEditable==!0?(r="",r=r+'<div class="demo-content"  >',r=r+'<select id="regulatory_status_selected_'+i.RowNo+'" class="form-control textvalid singleselect regulatorystatus_c" data-lineno="'+i.RowNo+'"  data-name="'+t.colModel.name+'" singleselect>',r=r+'<option value="0">Select<\/option>',r=r+"<\/select>",r=r+'<span class="text-danger _hide" id="regulatory_status_selected_'+i.RowNo+'_valid">Please select Regulatory Status<\/span>',r+"<\/div>"):(r="",r=r+'<div class="demo-content"  >',r=r+'<select id="regulatory_status_selected_'+i.RowNo+'" class="form-control textvalid singleselect regulatorystatus_c" data-lineno="'+i.RowNo+'"  data-name="'+t.colModel.name+'" singleselect disabled>',r=r+'<option value="0">Select<\/option>',r=r+"<\/select>",r=r+'<span class="text-danger _hide" id="regulatory_status_selected_'+i.RowNo+'_valid">Please select Regulatory Status<\/span>',r+"<\/div>")}},{name:"CRemarks",width:125,formatter:function(n,t,i){return i.IsEditable==!0?'<div class="demo-content"><textarea class="form-control textvalid form-control-sm Cremarks_text noSpacesField" id="cremarks_selected_'+i.RowNo+'" rows="2"  data-lineno="'+i.RowNo+'" data-name="'+t.colModel.name+'"><\/textarea><span class="text-danger _hide" id="cremarks_selected_'+i.RowNo+'_valid" >Please enter Remarks<\/span><\/div>':'<div class="demo-content"><textarea class="form-control textvalid form-control-sm Cremarks_text noSpacesField" id="cremarks_selected_'+i.RowNo+'" rows="2"  data-lineno="'+i.RowNo+'" data-name="'+t.colModel.name+'" readonly><\/textarea><span class="text-danger _hide" id="cremarks_selected_'+i.RowNo+'_valid" >Please enter Remarks<\/span><\/div>'}},{name:"ImpactDates",width:55,search:!1,formatter:function(n,t,i){return i.IsEditable==!0?'<div class="demo-content" ><input type="text" readonly class= "form-control form-control-sm data-datepicker ImpactDates_text ImpactDates_text_freezed" data-lineno="'+i.RowNo+'" data-name="'+t.colModel.name+'"/> <\/div>':'<div class="demo-content" ><input type="text" disabled class= "form-control form-control-sm data-datepicker ImpactDates_text" data-lineno="'+i.RowNo+'" data-name="'+t.colModel.name+'"/> <\/div>'}},{name:"References",width:60,formatter:function(n,t,i){return i.IsEditable==!0?'<div class="demo-content" ><input type="text" class= "form-control form-control-sm  References_text noSpacesField" data-lineno="'+i.RowNo+'" data-name="'+t.colModel.name+'"/> <\/div>':'<div class="demo-content" ><input type="text" class= "form-control form-control-sm  References_text noSpacesField" data-lineno="'+i.RowNo+'" data-name="'+t.colModel.name+'" readonly/> <\/div>'}},{name:"ReferenceDoc",width:80,name:"ReferenceDoc",formatter:function(n,t,i){return i.IsEditable==!0?'<div class="demo-content"><input type="file" id="RefDoc_'+i.RowNo+'" class="form-control form-control-sm RefDocs_text" data-regionId="'+i.RegionId+'" data-categoryId="'+i.CategoryId+'" data-lineno="'+i.RowNo+'" data-name="'+t.colModel.name+'" accept=".pdf, .docx, .xlsx,xls,.docx" multiple/><\/div>':'<div class="demo-content"><input type="file" id="RefDoc_'+i.RowNo+'" class="form-control form-control-sm RefDocs_text" data-regionId="'+i.RegionId+'" data-categoryId="'+i.CategoryId+'" data-lineno="'+i.RowNo+'" data-name="'+t.colModel.name+'" accept=".pdf, .docx, .xlsx,xls,.docx" multiple disabled/><\/div>'}},],cmTemplate:{sortable:!1},loadonce:!0,viewrecords:!0,pager:"#list_pager",rowNum:200,hoverrows:!1,scroll:1,beforeSelectRow:function(){return!1},gridComplete:function(){bindregulatorystatusDropDown();$(".regulatorystatus_c").select2()}});$(".ui-jqgrid-bdiv").css({"max-height":"58vh"});$(".ui-jqgrid-bdiv").children("div").css({"min-height":"0vh"});i=$(".ui-jqgrid-bdiv").find("tbody").height();i>130?($(".ui-jqgrid").find(".ui-jqgrid-bdiv").css("overflow","auto"),$(".-virtual-scroll").find(".ui-jqgrid-hdiv").css("padding-right","10px")):($(".ui-jqgrid").find(".ui-jqgrid-bdiv").css("overflow","auto"),$(".-virtual-scroll").find(".ui-jqgrid-hdiv").css("padding-right","0px"));$("#list").closest("#gview_list").css({"z-index":"0"});$("[data-singleselect]").select2();$(".data-singleselect").select2();$(".data-singleselect").select2({dropdownParent:$("#add_project")});$(".data-datepicker").datepicker({todayHighlight:!0,format:"dd/mm/yyyy",autoclose:!0})});$("#save_draftbtn").on("click",function(){var i=!0,t=$("#IngredientName").val(),u=$("#Synonyms").val(),f=$("#CASNumber").val(),e=$("#FunctionId_arr").val().join(",").toString(),o=$("#Division_Id").val(),n=new FormData,r;n.append("IngredientName",t);n.append("Synonyms",u);n.append("CASNumber",f);n.append("FunctionId",e);n.append("GridData",JSON.stringify(gridData));n.append("JsonFileNames",JSON.stringify(fileName));n.append("DocumentData",JSON.stringify(documentData));n.append("Division_Id",$("#Division_Id").val());n.append("IsConfirmed",0);ingredientId>0?n.append("Source",$("#Source").val()):"";ingredientId>0&&$("#Source").val().toLowerCase()=="ingredientrequest"&&(r=ingredientNames.findIndex(function(n){return n.IngredientName.trim().toLowerCase()===t.trim().toLowerCase()}),r>-1&&(alert("Ingredient Name Already Exists"),i=!1));t==null||t===""||typeof t=="undefined"?($("#IngredientName_valid").removeClass("_hide"),$("#IngredientName_exists").addClass("_hide"),i=!1):$("#IngredientName_valid").addClass("_hide");i&&(validateSave()?handelConfirmPopup("Are you sure, you want to save the ingredients details as draft",function(){n.append("DocumentData",JSON.stringify(documentData));$.ajax({url:ROOT+"NewRID/SaveDetails",dataType:"JSON",type:"POST",data:n,contentType:!1,processData:!1,success:function(n){var t=n.split("_")[1];n.includes("Successfully")?(SaveUploadedFiles(t,"Save"),window.location.href=ROOT+"NewRID/IngredientsRegulation"):alert(n)},error:function(){alert(" An Error occured!!")}})}):alert("There are no changes to save"))});$("#savebtn").on("click",function(){var t=!0,i=$("#IngredientName").val(),y=$("#Synonyms").val(),p=$("#CASNumber").val(),r=$("#FunctionId_arr").val().join(",").toString(),w=$("#Division_Id").val(),n=new FormData,v;n.append("IngredientName",i);n.append("Synonyms",y);n.append("CASNumber",p);n.append("FunctionId",r);n.append("GridData",JSON.stringify(gridData));n.append("JsonFileNames",JSON.stringify(fileName));n.append("DocumentData",JSON.stringify(documentData));n.append("Division_Id",$("#Division_Id").val());ingredientId>0?n.append("Source",$("#Source").val()):"";var u=[],e=login_region.length==1?login_region[0]:"atleast one",o="Please enter the Regulatory Status and Compliance Remarks for "+e+" Region ",f=0,s=0,h=0,c=!0,l=!0,a=!1;if(i==null||i===""||typeof i=="undefined"?($("#IngredientName_valid").removeClass("_hide"),$("#IngredientName_exists").addClass("_hide"),t=!1):$("#IngredientName_valid").addClass("_hide"),r==null||r===""||typeof r=="undefined"||r.length===0?($("#FunctionId_arr_valid").removeClass("_hide"),t=!1):$("#FunctionId_arr_valid").addClass("_hide"),$.each(gridData,function(n,t){u.indexOf(parseInt(t.RegionId))>-1?"":u.push(parseInt(t.RegionId))}),$.each(u,function(n,t){var r=gridData.filter(function(n){return parseInt(n.RegulatoryStatus)!=0&&parseInt(t)===parseInt(n.RegionId)}).length,u=gridData.filter(function(n){return!(n.CRemarks===""||n.CRemarks===null)&&parseInt(t)===parseInt(n.RegionId)}).length,i=gridData.filter(function(n){return parseInt(t)===parseInt(n.RegionId)}).length,v=gridData.filter(function(n){return!(parseInt(n.RegulatoryStatus)===0&&(n.CRemarks===""||n.CRemarks===null))&&parseInt(t)===parseInt(n.RegionId)}),y=gridData.filter(function(n){return parseInt(t)===parseInt(n.RegionId)});r===i&&u===i?f++:f;c&&l&&(r===i?s++:s,u===i?h++:h,r==0&&u==0||(r==i||u==i)&&(a=!0,r!=i&&(c=!1,o="Please enter the Regulatory Status for "+e+" Region "),u!=i&&(l=!1,o="Please enter the Compliance Remarks for "+e+" Region ")))}),$.each(u,function(n,i){var r=gridData.filter(function(n){return parseInt(n.RegulatoryStatus)!=0&&parseInt(i)===parseInt(n.RegionId)}).length,u=gridData.filter(function(n){return!(n.CRemarks===""||n.CRemarks===null)&&parseInt(i)===parseInt(n.RegionId)}).length,e=gridData.filter(function(n){return parseInt(i)===parseInt(n.RegionId)}).length,s=gridData.filter(function(n){return!(parseInt(n.RegulatoryStatus)===0&&(n.CRemarks===""||n.CRemarks===null))&&parseInt(i)===parseInt(n.RegionId)}),h=gridData.filter(function(n){return parseInt(i)===parseInt(n.RegionId)}),o;(r>0||u>0)&&(r<e||u<e)&&(o=f===0&&a==!1?h:s,$.each(o,function(n,i){parseInt(i.RegulatoryStatus)===0?($("#regulatory_status_selected_"+i.RowNo+"_valid").removeClass("_hide"),t=!1):$("#regulatory_status_selected_"+i.RowNo+"_valid").addClass("_hide");i.CRemarks===""||i.CRemarks===null?($("#cremarks_selected_"+i.RowNo+"_valid").removeClass("_hide"),t=!1):$("#cremarks_selected_"+i.RowNo+"_valid").addClass("_hide")}))}),f===0&&(alert(o),t=!1),ingredientId>0&&$("#Source").val().toLowerCase()=="ingredientrequest"&&(v=ingredientNames.findIndex(function(n){return n.IngredientName.trim().toLowerCase()===i.trim().toLowerCase()}),v>-1&&(alert("Ingredient Name Already Exists"),t=!1)),t){$("#Remarks_modal").modal("show");$("#SendtoApproveRevert").off("click").on("click",function(){var t={IngredientId:ingredientId,Approvallevel:"",Action:"Sent for Level 1 Approval",Remarks:$("#Remarks_text").val().trim()};n.append("DocumentData",JSON.stringify(documentData));$.ajax({url:ROOT+"NewRID/SaveDetails",dataType:"JSON",type:"POST",data:n,contentType:!1,processData:!1,success:function(n){var t=n.split("_")[1];n.includes("Successfully")?(SaveUploadedFiles(t,"Save"),window.location.href=ROOT+"NewRID/IngredientsRegulation"):alert(n)},error:function(){alert(" An Error occured!!")}})})}});$("#IngredientName").on("change",function(){var n=$(this).val().trim(),t=ingredientNames.findIndex(function(t){return t.IngredientName.trim().toLowerCase()===n.trim().toLowerCase()});t>-1&&($("#IngredientName_exists").removeClass("_hide"),$("#IngredientName_valid").addClass("_hide"))});$(document).on("change",".regulatorystatus_c",function(n){var n=$(this),t=parseInt($(n).data("lineno")),r=$(n).data("name"),i=gridData.findIndex(n=>n.RowNo===t),u=$("#list").getRowData(t);i>=0&&(gridData[i][r]=$(this).val())});$(document).on("change",".RefDocs_text",function(n){for(var c,f,l,y,i,e=!0,p=$(this).data("lineno"),r=$(this).data("regionid"),u=$(this).data("categoryid"),o=n.target.files.length,a=$(this).data("name"),v=parseInt($(this).data("lineno")),s=gridData.findIndex(n=>n.RowNo===v),h=0,o=n.target.files.length,t=0;t<o;t++)h+=n.target.files[t].size;if(c=10485760,h>c)return alert("The file size should be less than 10 MB"),$(this).val(""),e=!1,!1;if(e){for(s>=0&&(gridData[s][a]=i),f=documentData.filter(function(n){return n.RegionId===r&&n.CategoryId===u}).length;f>0;)l=documentData.findIndex(n=>n.RegionId===r&&n.CategoryId===u),documentData.splice(l,1),f--;for(t=0;t<o;t++)y=n.target.files[t],i=n.target.files[t].name,documentData.push({RegionId:r,CategoryId:u,EnclosureName:i.replaceAll(" ","")}),fileName.push(i.replaceAll(" ",""))}});$(document).on("keyup",".Cremarks_text",function(){var n=$(this),i=parseInt($(n).data("lineno")),r=$(n).data("name"),t=gridData.findIndex(n=>n.RowNo===i);t>=0&&(gridData[t][r]=$(this).val())});$(document).on("change",".ImpactDates_text",function(){var n=$(this),i=parseInt($(n).data("lineno")),r=$(n).data("name"),t=gridData.findIndex(n=>n.RowNo==i);t>=0&&(gridData[t][r]=convertToDate($(this).val()))});$(document).on("keyup",".References_text",function(){var n=$(this),i=parseInt($(n).data("lineno")),r=$(n).data("name"),t=gridData.findIndex(n=>n.RowNo==i);t>=0&&(gridData[t][r]=$(this).val())});$(document).on("keyup",".INCI_text",function(){var n=$(this),i=parseInt($(n).data("lineno")),r=$(n).data("name"),t=gridData.findIndex(n=>n.RowNo==i);t>=0&&(gridData[t][r]=$(this).val())});$("#cancelbtn").click(function(){window.location.href=ROOT+"NewRID/IngredientsRegulation"});$(".data-multiselect").multiselect({enableFiltering:!0,includeSelectAllOption:!0,enableCaseInsensitiveFiltering:!0,maxHeight:5,buttonWidth:"75%",dropUp:!0});