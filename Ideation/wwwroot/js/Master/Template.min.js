function CreateJqGrid(n){$("#jqgrid").jqGrid({url:"",datatype:"local",data:n,mtype:"GET",colModel:models,loadonce:!0,viewrecords:!0,sortable:!1,rowNum:20,scroll:1,pager:"#pager",gridComplete:function(){var t=$("#jqgrid tbody tr"),r=$("#jqgrid tbody tr td"),n;if(t.length>1)for(n=$(t[1]).children("td"),i=0;i<n.length;i++)$(n[i]).css("width",$(r[i]).css("width"))},loadComplete:function(){var i=$("#jqgrid").getDataIDs(),n=$("#jqgrid"),t=n.jqGrid("getCol","Amount",!1,"sum");n.jqGrid("footerData","set",{OrderQtyInPallets:"Total Amount $:"});n.jqGrid("footerData","set",{Amount:parseFloat(n.jqGrid("getCol","Amount",!1,"sum")).toFixed(2)});$(".tamounteuro").text(parseFloat(t).toFixed(2));parseInt(t)!==0?$(".tamountdlr").text(parseFloat(1/t).toFixed(2)):0}});$("#jqgrid").jqGrid("filterToolbar",{autosearch:!0,stringResult:!1,searchOnEnter:!1,defaultSearch:"cn"});$(".ui-jqgrid-bdiv").css({"max-height":"300px"});$(".ui-jqgrid-bdiv").children("div").css({height:"auto"});var t=$(".ui-jqgrid-bdiv").find("tbody").height();t>278?($(".ui-jqgrid").find(".ui-jqgrid-bdiv").css("overflow","auto"),$(".m-table__responsive").find(".ui-jqgrid-htable").css("padding-right","17px")):$(".m-table__responsive").find(".ui-jqgrid-htable").css("padding-right","0px");$(".allownumericwithdecimal").keypress(function(n){var t=n.which?n.which:event.keyCode;if(String.fromCharCode(t).match(/[^0-9,\b]/g))return!1});$(".txtOnly").keypress(function(n){var t=n.keyCode;t>=48&&t<=57&&n.preventDefault()})}function dataBind(){var i=[],n,r,u,f,t;for($("#multipleSelect option:selected").each(function(){var n=$(this),t;n.length&&(t=n.text(),miltones.push(t))}),n=[],r=["1",],r=$.merge(r,$("#multipleSelect").val()),u=0;u<=r.length-1;u++)f=MilestoneMasterList.filter(function(n){return n.SequenceNo==r[u]}),n.push(f[0]);for(n=n.filter(function(n){return n!=undefined}),t=0;t<=n.length-1;t++)console.log(n[t].SequenceNo),n[t].SequenceNo>=0&&i.push({SequenceNo:n[t].SequenceNo,MilestoneId:n[t].MilestoneId,MilestoneName:n[t].MilestoneName,SetRelation:n[t].SetRelation,Duration:n[t].Duration,SubmilestoneExit:n[t].SubmilestoneExit});i.length>0&&($.each(i,function(n){objindex=i.findIndex(t=>t.SequenceNo==i[n].SetRelation);objindex==-1&&(i[n].SetRelation="")}),Griddata=i,$("#jqgrid").jqGrid("clearGridData",!0),$("#jqgrid").jqGrid("setGridParam",{data:i}),$("#jqgrid").trigger("reloadGrid"),CreateJqGrid(i),displayDuration(),$(".ui-jqgrid-bdiv").css({"max-height":"300px"}),$(".ui-jqgrid-bdiv").children("div").css({height:"auto"}))}function ChangeSetRelation(n,t){var r=$("#jqgrid").jqGrid("getRowData",n),f=$("#"+r.SequenceNo+"SetRelation").val(),u=Griddata.findIndex(n=>n.SequenceNo==f),e,i;if(u>=0)if(e=$("#"+r.SequenceNo+"SetRelation").val(),u=Griddata.findIndex(n=>n.SequenceNo==t),Griddata[u].SetRelation=e,findloopingSubgrid(r.SequenceNo,[],"jqgrid"),looping)for(i=0;i<=milestoneid_looping.length-1;i++)$("#jqgrid tbody tr").each(function(n,t){$(t).find("td:nth-child(4)").text()==milestoneid_looping[i]&&$(t).closest("tr").children("td,th").css("background-color","")});else for(i=0;i<=milestoneid_looping.length-1;i++)$("#jqgrid tbody tr").each(function(n,t){$(t).find("td:nth-child(4)").text()==milestoneid_looping[i]&&$(t).closest("tr").children("td,th").css("background-color","orange")});else alert("The entered set relation milestone is not selected in the milestone list"),$("#"+r.SequenceNo+"SetRelation").val("");r.SequenceNo==f&&(alert("Please enter the set relation greater or less than the selected milestone"),$("#"+r.SequenceNo+"SetRelation").val(""))}function ChangeDuration(n,t){var i=$("#jqgrid").jqGrid("getRowData",n),r=$("#"+i.SequenceNo+"Duration").val(),u=Griddata.findIndex(n=>n.SequenceNo==t);Griddata[u].Duration=r}function displayDuration(){var u=$.grep(Griddata,function(n){return n.SubmilestoneExit==="True"}),r,i,e,n,t,f;for(console.log("pmugridData",u),r=0;r<u.length;r++){for(rowSequnce=u[r].SequenceNo,SelectedSubMilestoneData=[],i=0;i<TotalSubGridData.length;i++)e=TotalSubGridData[i].findIndex(n=>n.SequenceNo==rowSequnce),e!=-1&&(SelectedSubMilestoneData=TotalSubGridData[i]);n=[];n.push({SubMilestoneId:SelectedSubMilestoneData[0].SubMilestoneId,Duration:SelectedSubMilestoneData[0].Duration});$.each(SelectedSubMilestoneData,function(t,i){var f=i.SetRelation,r=n.findIndex(n=>n.SubMilestoneId==f),u;i.RelationType=="FS ( Sequence)"?(u=parseInt(i.Duration)+parseInt(n[r].Duration),n.push({SubMilestoneId:SelectedSubMilestoneData[t].SubMilestoneId,Duration:u})):i.RelationType=="SS ( Parallel )"&&(parseInt(i.Duration)>parseInt(n[r].Duration)?n.push({SubMilestoneId:SelectedSubMilestoneData[t].SubMilestoneId,Duration:i.Duration}):n.push({SubMilestoneId:SelectedSubMilestoneData[t].SubMilestoneId,Duration:n[r].Duration}))});console.log("Data",n);t=-Infinity;$.each(n,function(n,i){i.Duration>t&&(t=i.Duration)});console.log("highestSalary",t);f=Griddata.findIndex(n=>n.SequenceNo==SelectedSubMilestoneData[0].SequenceNo);Griddata[f].Duration=t;$("#"+Griddata[f].SequenceNo+"Duration").val(t)}}function findloopingSubgrid(n,t,i){var r;if(t.includes(n))return alert("There is circle dependency found between the milestones "+n+" and its relations are: "+t),milestoneid_looping=t,looping=!1,!0;if(looping=!0,r=Griddata,objIndex=r.findIndex(t=>t.SequenceNo==n),objIndex>0)var u=r[objIndex].SetRelation.split(","),f=Math.max.apply(Math,u),e=f;else return!0;return t.push(n),findloopingSubgrid(e,t,i),!1}var miltones=[],iserror=!0,Griddata=[],TemplateName="",subgrid_table_id=[],DurationChange=!0,Subgrid_data=[],PrevSelectedMilestone=[],MilestoneMasterList=[],rowSequnce="",TotalSubGridData=[],firstLoad=!0,looping=!0,milestoneid_looping;$(document).ready(function(){$("#ProjectId").hide();$(".projectName_error").hide();$("#projectNameList").hide();$("[data-multiselect]").multiselect({includeSelectAllOption:!0,buttonWidth:220,enableCaseInsensitiveFiltering:!0,enableFiltering:!0});$("#multipleSelect").find("option[value=1]").prop("selected","selected");$("#multipleSelect").find("option[value=1]").attr("disabled",!0);$("#multipleSelect").multiselect("refresh");$(".projectName_error").css("display","none");models=[{name:"MilestoneId",label:"Milestone Id",resizable:!0,ignoreCase:!0,hidden:!0,sortable:!1},{name:"RowId",label:"RowId",resizable:!0,ignoreCase:!0,hidden:!0,sortable:!1},{name:"SequenceNo",label:"Milestone No",resizable:!0,ignoreCase:!0,sortable:!1},{name:"MilestoneName",resizable:!0,label:"Milestone Name",ignoreCase:!0,sortable:!1},{name:"MilestoneStatus",resizable:!0,hidden:!0,label:"Milestone Name",ignoreCase:!0,sortable:!1},{name:"SetRelation",label:"Set Relation",resizable:!0,ignoreCase:!0,sortable:!1,formatter:function(n,t,i){return i.SequenceNo==1?($("#1SetRelation").hide(),""):n==undefined?'<input type="text"   data-id="'+t.rowId+'" id="'+i.SequenceNo+'SetRelation" class="form-control allownumericwithdecimal"  onchange="ChangeSetRelation('+t.rowId+","+i.SequenceNo+')" />':i.MilestoneStatus=="Completed"||i.IsApproved=="Pending For Approval"?'<input type="text" data-id="'+t.rowId+'" id="'+i.SequenceNo+'SetRelation" value="'+i.SetRelation+'" class="form-control allownumericwithdecimal"  onchange="ChangeSetRelation('+t.rowId+","+i.SequenceNo+')" readonly />':'<input type="text" data-id="'+t.rowId+'" id="'+i.SequenceNo+'SetRelation" value="'+i.SetRelation+'" class="form-control allownumericwithdecimal"  onchange="ChangeSetRelation('+t.rowId+","+i.SequenceNo+')"  />'}},{name:"RelationType",label:"RelationType",resizable:!0,ignoreCase:!0,hidden:!0,sortable:!1},{name:"Duration",label:"Duration",resizable:!0,ignoreCase:!0,sortable:!1,formatter:function(n,t,i){return n==undefined?'<input type="text" data-id="'+t.rowId+'"    id="'+i.SequenceNo+'Duration" class="form-control duration allownumericwithdecimal" placeholder="Duration" onchange="ChangeDuration('+t.rowId+","+i.SequenceNo+')" />':i.SubmilestoneExit=="True"?'<input type="text" data-id="'+t.rowId+'" id="'+i.SequenceNo+'Duration" value="'+i.Duration+'" class="form-control duration allownumericwithdecimal" placeholder="Duration" onchange="ChangeDuration('+t.rowId+","+i.SequenceNo+')" readonly />':'<input type="text" data-id="'+t.rowId+'" id="'+i.SequenceNo+'Duration" value="'+i.Duration+'" class="form-control duration allownumericwithdecimal" placeholder="Duration" onchange="ChangeDuration('+t.rowId+","+i.SequenceNo+')"  />'}},{name:"SubmilestoneExit",label:"SubmilestoneExit",resizable:!0,ignoreCase:!0,hidden:!0,sortable:!1,classes:"submilestoneexist"},];CreateJqGrid("")});$("#multipleSelect").on("change",function(){TemplateName=$("#TemplateName").val();TemplateName==""&&$("#ErrorMeassage").text("Please enter the Template name")});$("#btnAdd").on("click",function(){var r=$("#Name").val();if(DurationChange=!0,$("#Name").val()=="")$("#ErrorMeassage").text("Please enter the template name"),iserror=!1;else{iserror=!0;var t="1",n=$("#multipleSelect").val(),i=$.grep(n,function(n){return $.inArray(n,PrevSelectedMilestone)===-1});PrevSelectedMilestone=n;n.length==0&&$("#MilestoneList_Error").text("Please select the milestone for template creation");$.each(n,function(i){t=t.concat(",",n[i])});firstLoad=!0;TotalSubGridData=[];$.ajax({url:ROOT+"Master/MilestoneBasedDuration",type:"POST",dataType:"JSON",data:{MilestoneName:t},success:function(n){var t,r;if(console.log("result",n),MilestoneMasterList.length==0)MilestoneMasterList=n;else for(t=0;t<i.length;t++)r=n.findIndex(n=>n.SequenceNo==i[t]),MilestoneMasterList.push(n[r]);dataBind()},error:function(n,t,i){console.log("err",n,t,i)}})}});$("#SaveModel").on("click",function(){var u=$("#Name").val(),t,n;if($("#Name").val()==""&&($("#ErrorMeassage").text("Please enter the template name"),iserror=!1),Griddata.length==0)return alert("Please select the check box "),!1;if(looping){var i="",r="",f="";if(Griddata[0].SetRelation="0",$.each(Griddata,function(n){Griddata[n].IsMainMilestone="Yes"}),$.each(Griddata,function(n,t){t.SetRelation==""&&(i=1);t.Duration==""&&(r=1);t.RelationType==""&&(f=1)}),i===1)return alert("Please enter the set relation"),!1;if(r===1)return alert("Please Enter the Duration"),!1;for(t=0;t<=subgrid_table_id.length-1;t++)n=$("#"+subgrid_table_id[t]).jqGrid("getGridParam","data"),$.each(n,function(t){n[t].IsMainMilestone="No";Griddata.push({Duration:n[t].Duration,IsMainMilestone:n[t].IsMainMilestone,MilestoneId:n[t].SubMilestoneId,MilestoneName:n[t].SubMilestoneName,SequenceNo:n[t].SequenceNo,SetRelation:n[t].SetRelation,RelationType:n[t].RelationType})});TableDetails=JSON.stringify(Griddata);iserror&&$("#ErrorMeassage").text().trim().length==0&&$.ajax({url:ROOT+"Master/TemaplateDetailsSave",type:"POST",dataType:"JSON",data:{TableDetails:TableDetails,TemplateName:u},success:function(n){console.log(n);location.reload()},error:function(n,t,i){console.log("err",n,t,i)}})}});$("#Name").on("focusout",function(){$.ajax({url:ROOT+"Master/TemplateList",type:"get",datatype:"json",success:function(n){console.log(n);var t=n,i=t.findIndex(n=>n.TemplateName.toUpperCase()==$("#Name").val().toUpperCase());i>=0?$("#ErrorMeassage").text("The entered  template name already exists"):$("#ErrorMeassage").text("")}})});milestoneid_looping=[];